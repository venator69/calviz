<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="style.css">
    <title>Calviz</title>
</head>

<body>
<div class="topnav" id="myTopnav">
  <a href="index.html" class="active">CALVIZ</a>
  <a href="index.html">Home</a>
  <a href="riemann.html">Riemann Integral</a>
  <a href="derivative.html">Derivative</a>
  <a href="limit.html">L'hospital</a>
  <a href="series.html">Taylor series</a>
  <a href="login.html" class="login">login</a>

  <div class="profile-dropdown" id="pp">
    <img src="assets/default.jpg" alt="Profile picture" id="profilePic">
    <div class="dropdown-content" id="logoutMenu">
      <a href="javascript:void(0);" id="logoutBtn">Logout</a>
    </div>
  </div>

  <a href="javascript:void(0);" class="icon">
    <i class="fa fa-bars"></i>
  </a>
</div>

  <div class="wrapper">
    <div class="content" id="hoverBtn">
      <audio loop id="hoverAudio">
      <source src="Autopilot.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
      </audio>
      <div class="typewriter">
        <div class="title"> Welcome to CALVIZ !!</div>
        <div class="pronoun">Welcome to</div>
        <div class="pronoun">CALVIZ !!</div>
      </div>
      <div class="subtitle">Interactive calculus visualization for visual learners</div> 
      <div class="buttons">
        <a href="riemann.html">
          <button class="butts" id="integral">Riemann Integral</button>
        </a>
        <a href="derivative.html">
          <button class="butts" id="derivative">Derivative</button>
        </a>
      </div>
            <div class="buttons">
        <a href="limit.html">
          <button class="butts" id="limit">L'Hospital</button>
        </a>
        <a href="series.html">
          <button class="butts" id="series">Taylor series</button>
        </a>
      </div>
    </div>
    <div class="image-container">
      <div id="hoverimage">
        <img src="assets/profile.png" alt="Profile picture">
      </div>
      <div class="songtitle" id="songtitlebig">
        <button id="muteBtn">
          <i id="muteIcon" class="fa fa-volume-off"></i> 
        </button>
        <i> Song : Autopilot - Kitsch</i>
      </div>
    </div>
      <div class="songtitle" id="songtitlesmall">
        <button id="muteSm">
          <i id="muteIconSm" class="fa fa-volume-off"></i> 
        </button>
        <i> Song : Autopilot - Kitsch</i>
      </div>

  </div>
  <div class="social">
    <div class="content">
      <div class="typewriter">
        <div class="subtitle">My Socials : </div>
      </div>
    <div class="socials">
      <a href ="https://discord.com/users/864557474853290034">
        <div class="social-icons">
          <img src="assets/discord.png" alt="Profile picture"><span class="links">DISCORD</span>
        </div>
      </a>
      <a href ="https://www.instagram.com/kletka69420/?next=%2F">      
        <div class="social-icons">
          <img src="assets/ig.png" alt="ig"><span class="links">INSTAGRAM</span>
        </div>
      </a>
      <a href ="https://www.linkedin.com/feed/?trk=guest_homepage-basic_google-one-tap-submit">
        <div class="social-icons">
          <img src="assets/linkedin.png" alt="Profile picture"><span class="links">LINKEDIN</span>
        </div>
      </a>
      <a href="https://www.youtube.com/@transracialtrain9151">
        <div class="social-icons">
          <img src="assets/youtube.png" alt="Profile picture"><span class="links">YOUTUBE</span>
        </div>
      </a>
      <a href="https://github.com/venator69">
        <div class="social-icons">
          <img src="assets/github.png" alt="Profile picture"><span class="links">GITHUB</span>
        </div>
      </a>
    </div>
  </div>


</body>
<footer>
<script>
document.addEventListener("DOMContentLoaded", async () => {

  // -----------------------------
  // LOGIN FUNCTION
  // -----------------------------
  async function loginUser(name, password) {
    if (!name || !password) return alert("Name dan password wajib diisi");

    try {
      const res = await fetch("https://calviz-server-production.up.railway.app/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, password }),
        credentials: "include" // penting untuk session cookie
      });

      const data = await res.json().catch(() => ({}));
      if (res.ok) {
        console.log("Login sukses", data);
        alert("Login berhasil!");
        await handleLoginState();
      } else {
        alert(`Login gagal: ${data.message || res.status}`);
      }
    } catch (err) {
      console.error("Login error:", err);
      alert("Login error: " + err.message);
    }
  }

  // -----------------------------
  // LOGOUT FUNCTION
  // -----------------------------
  async function logout() {
    try {
      await fetch("https://calviz-server-production.up.railway.app/logout", {
        method: "POST",
        credentials: "include"
      });
      location.reload(); // reload untuk refresh state
    } catch (err) {
      console.error("Logout error:", err);
    }
  }

  // -----------------------------
  // PROFILE CHECK FUNCTION
  // -----------------------------
  async function handleLoginState() {
    try {
      const res = await fetch("https://calviz-server-production.up.railway.app/profile", {
        method: "GET",
        credentials: "include"
      });
      const data = await res.json().catch(() => ({}));
      const loginLink = document.querySelector(".login");
      const profilePic = document.querySelector("#pp");
      const usernameLabel = document.querySelector("#username");



      if (res.ok && data.name) {
        if (loginLink) loginLink.style.display = "none";
        if (profilePic) {
          profilePic.style.display = "flex";
          profilePic.querySelector("img").src = data.profile_picture || "default.jpg";
        }
        if (usernameLabel) usernameLabel.textContent = data.name;
      } else {
        if (loginLink) loginLink.style.display = "flex";
        if (profilePic) profilePic.style.display = "none";
      }
    } catch (err) {
      console.error("Profile fetch error:", err);
    }
  }

  // -----------------------------
  // FORM SUBMIT LISTENER
  // -----------------------------
  const loginForm = document.getElementById("loginForm");
  if (loginForm) {
    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("nameInput").value.trim();
      const password = document.getElementById("passwordInput").value.trim();
      loginUser(name, password);
    });
  }

  // -----------------------------
  // LOGOUT BUTTON
  // -----------------------------
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) logoutBtn.addEventListener("click", logout);

  // -----------------------------
  // INITIAL CHECK
  // -----------------------------
  await handleLoginState();

  // -----------------------------
  // EXISTING HOVER IMAGE & AUDIO LOGIC
  // -----------------------------
  const profileDropdown = document.getElementById('pp');
  const logoutMenu = document.getElementById('logoutMenu');
  const img = document.querySelector("#hoverimage img");
  const buttonImages = { integral: "assets/profile.png", derivative: "assets/derivative.png", limit: "assets/limit.png", series: "assets/series.png" };
  function changeImage(newSrc) {
    img.classList.add("fade-out");
    setTimeout(() => { img.src = newSrc; img.classList.remove("fade-out"); }, 300);
  }
  for (let id in buttonImages) {
    const btn = document.getElementById(id);
    if (btn) btn.addEventListener("mouseenter", () => changeImage(buttonImages[id]));
  }

  const topnav = document.getElementById("myTopnav");
  document.querySelector(".topnav .icon")?.addEventListener("click", () => topnav.classList.toggle("responsive"));

  const audio = document.getElementById('hoverAudio');
  const muteBtn = document.getElementById('muteBtn');
  const muteIcon = document.getElementById('muteIcon');
  if (muteBtn) muteBtn.addEventListener('click', () => { if(audio.paused) audio.play(); audio.muted = !audio.muted; muteIcon.className = audio.muted ? "fa fa-volume-off" : "fa fa-volume-up"; });

  // Toggle show class
  // for logout dropdown menu

  profileDropdown.addEventListener('click', (e) => {
    e.stopPropagation(); // mencegah klik ditangkap document
    logoutMenu.classList.toggle('show-dropdown');
  });

  document.addEventListener('click', (e) => {
    if (!profileDropdown.contains(e.target)) {
      logoutMenu.classList.remove('show-dropdown');
    }
  });

});
</script>
</footer>
</html>
